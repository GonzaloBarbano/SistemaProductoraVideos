@startuml
title Diagrama de Actividades – Cambiar Estado de Etapa

|Responsable de Etapa|
start
:Seleccionar etapa a modificar;
:Solicitar cambio de estado;
:Agregar observaciones (opcional);

|Sistema de Gestión|
:Recibir solicitud de cambio;
:Validar reglas de negocio;
note right
Las reglas de negocio incluyen:
- Validar que el usuario tenga permisos para el cambio.
- Comprobar que el estado solicitado sea coherente
  con el flujo de trabajo definido.
- Confirmar que no existan tareas pendientes
  o bloqueos asociados.
end note

if (Precondiciones ok?) then (no)
  :Rechazar cambio y devolver motivo;
  |Responsable de Etapa|
  :Recibir motivo de rechazo;
  end
else (sí)
  :Evaluar impacto en cronograma;
  note right
  La evaluación del impacto se realiza automáticamente
  por el Sistema de Gestión a partir de dependencias
  y fechas previstas.
  end note
endif

if (Cambio indica posible retraso?) then (sí)
  :Generar alerta de posible retraso;
  :Preparar aviso para Coordinador y Equipo;
  |Sistema de Gestión|
  :Derivar aviso al Servicio de Notificaciones;
  |Servicio de Notificaciones|
  :Enviar aviso a Coordinador y Equipo;
  |Coordinador/Productor|
  :Revisar alerta y decidir acción;
else (no)
  :Continuar sin alerta;
endif

|Sistema de Gestión|
fork
  :Registrar observaciones y adjuntos;
fork again
  :Registrar auditoría del cambio;
fork again
  :Actualizar estado de la etapa;
end fork

:Confirmar actualización exitosa;
|Responsable de Etapa|
:Recibir confirmación del cambio;
stop
@enduml
