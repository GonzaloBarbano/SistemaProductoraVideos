@startuml
title Gestionar Etapas de un Proyecto (Exitoso) - Sistema de Gestión de Etapas y Proyectos

actor Coordinador
actor Asistente
participant "PantallaProyecto : UI" as PantallaProyecto
participant "ServicioEtapa : Servicio" as ServicioEtapa
participant "RepositorioEtapas : Repositorio" as RepositorioEtapas
participant "ServicioNotificaciones : Servicio" as ServicioNotificaciones

== Inicio ==
Coordinador -> PantallaProyecto : abrir detalle del proyecto
activate PantallaProyecto
note right of PantallaProyecto
El coordinador accede al detalle del proyecto
y selecciona "Gestionar Etapas".
end note

PantallaProyecto -> ServicioEtapa : mostrar lista de etapas
activate ServicioEtapa
ServicioEtapa -> RepositorioEtapas : obtenerEtapas(Proyecto)
activate RepositorioEtapas
RepositorioEtapas -> ServicioEtapa : devolver lista de Etapa
deactivate RepositorioEtapas
ServicioEtapa -> PantallaProyecto : enviar lista de etapas
deactivate ServicioEtapa

== Gestión de etapas ==
Coordinador -> PantallaProyecto : seleccionar acción (agregar/editar/eliminar)

PantallaProyecto -> PantallaProyecto : mostrar formulario de etapa
note right of PantallaProyecto
Campos: nombre, responsable, estado,
fechas, observaciones.
end note

Coordinador -> PantallaProyecto : completar formulario
PantallaProyecto -> ServicioEtapa : validarEtapa(Etapa)
activate ServicioEtapa
note right of ServicioEtapa
Validación:
- Responsable existente
- Fechas coherentes
- Estado permitido
end note

alt Datos inválidos
    ServicioEtapa -> PantallaProyecto : mostrar errores
    deactivate ServiçoEtapa

else Datos válidos
    ServicioEtapa -> RepositorioEtapas : guardarEtapa(Etapa)
    activate RepositorioEtapas
    RepositorioEtapas -> ServicioEtapa : confirmar guardado
    deactivate RepositorioEtapas
end

== Adjuntar Material (Issue 76) ==
Asistente -> PantallaProyecto : solicitar adjuntar material
PantallaProyecto -> ServicioEtapa : adjuntarMaterial(Etapa, Material)
note right of ServicioEtapa
El asistente carga material asociado
a una etapa existente.
end note

ServicioEtapa -> RepositorioEtapas : guardarMaterial(Etapa, Material)
activate RepositorioEtapas
RepositorioEtapas -> ServicioEtapa : confirmar adjunto
deactivate RepositorioEtapas

== Notificación (Issue 78) ==
ServicioEtapa -> ServicioEtapa : generarEventoNotificable(Etapa, tipoCambio)
note right of ServicioEtapa
Evento incluye:
- Tipo de cambio (alta/edición/eliminación/material adjunto)
- Responsable afectado
- Proyecto y etapa involucrados
end note

ServicioEtapa -> ServicioNotificaciones : enviarNotificacion(Evento)
activate ServicioNotificaciones
note right of ServicioNotificaciones
Se compone el mensaje y se envía
al responsable afectado.
end note
ServicioNotificaciones -> ServicioEtapa : confirmar envío
deactivate ServicioNotificaciones

== Confirmación ==
ServicioEtapa -> PantallaProyecto : actualizar lista de etapas
PantallaProyecto -> Coordinador : mostrar confirmación
note right of PantallaProyecto
Se actualiza la lista y se confirma
la operación realizada.
end note

deactivate ServicioEtapa
deactivate PantallaProyecto

@enduml
