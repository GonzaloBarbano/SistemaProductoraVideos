@startuml
title Diagrama de Actividades - Cambiar Estado de Etapa 
|Responsable de Etapa|
start
:Seleccionar etapa a modificar;
:Solicitar cambio de estado;
:Agregar observaciones (opcional);

|Sistema de Gestión|
:Recibir solicitud de cambio;
:Validar reglas de negocio;

if (Precondiciones ok?) then (no)
  :Rechazar cambio y devolver motivo;
  |Responsable de Etapa|
  :Recibir motivo;
  end
else (sí)
  :Evaluar impacto en cronograma;
  if (Cambio indica posible retraso?) then (sí)
    :Generar alerta de posible retraso;
    |Servicio de Notificaciones|
    :Enviar aviso a Coordinador y Equipo;
    |Coordinador/Productor|
    :Revisar alerta y decidir acción;
  else (no)
    :Continuar sin alerta;
  endif

  |Sistema de Gestión|
  :Registrar observaciones y adjuntos;
  :Registrar auditoría del cambio;
  :Actualizar estado de la etapa;

  fork
    |Responsable de Etapa|
    :Subir adjuntos o evidencias;
  fork again
    |Servicio de Notificaciones|
    :Enviar notificación de cambio de estado;
  fork again
    |Asistente de Producción|
    :Actualizar documentación y logística;
  end fork

  |Sistema de Gestión|
  :Registrar resultados de envío;

  if (Hubo fallos?) then (sí)
    :Notificar Admin sobre fallos masivos;
    |Coordinador/Productor|
    :Tomar medidas correctivas;
  else (no)
    :Confirmar cambio exitoso;
  endif
endif

|Responsable de Etapa|
stop
@enduml
